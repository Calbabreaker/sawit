rules_version = '2';
service cloud.firestore {
    match /databases/{database}/documents {
        match /threads/{threadID} {
            allow read;

        }

        match /threads/{threadID}/posts/{postID} {
            allow read;
            allow create: if canCreatePost();
            allow update: if isValidPost(resource.data) && !diffKeys().hasAny(["uid", "username", "upvotes", "thread"]) || canChangeVotes(threadID, postID);

            match /votes/{userID} {
                allow read, write: if request.auth.uid == userID;
            }
        }

        match /users/{userID} {
            allow read;
            allow create: if isValidUserData(userID);
        }

        match /{path=**}/posts/{postID} {
            allow read;
        }

        function canCreatePost() {
            let isNow = request.time == request.resource.data.createdAt;
            let username = get(/databases/$(database)/documents/users/$(request.auth.uid)).data.name;
            let usernameMatches = username == request.resource.data.username;
            let isValidUpvotes = request.resource.data.upvotes == 0;
            let isValidThread = !("thread" in request.resource.data) || exists(/databases/$(database)/documents/threads/$(request.resource.data.thread));

            return isNow && usernameMatches && isValidUpvotes && isValidThread && isValidPost(request.resource.data);
        }

        function isValidPost(currentData) {
            let isOwner = currentData.uid == request.auth.uid;
            let isValidContent = request.resource.data.content.size() < 10000;
            let titleSize = request.resource.data.title.size();
            let isValidTitle = titleSize > 0 && titleSize < 100;
            
            return isOwner && isValidContent && isValidTitle;
        }

        function diffKeys() {
            return request.resource.data.diff(resource.data).affectedKeys();
        }

        function isValidUserData(userId) {
            let isOwner = request.auth.uid == userId;
            let isNow = request.time == request.resource.data.createdAt;
            let isValidDescription = request.resource.data.description.size() < 10000;
            let username = request.resource.data.name;

            return isOwner && isNow && isValidDescription && isValidUsername(username);  
        }

        function isValidUsername(value) {
            let username = value.lower();
            let isValidLength = username.size() >= 3 && username.size() <= 16;
            let hasValidChars = !username.matches('[^\\w-]');

            return isValidLength && hasValidChars;
        }

        function canChangeVotes(threadID, postID) {
		    let voteDocAfter = getAfter(/databases/$(database)/documents/threads/$(threadID)/posts/$(postID)/votes/$(request.auth.uid));
            let voteDoc = get(/databases/$(database)/documents/threads/$(threadID)/posts/$(postID)/votes/$(request.auth.uid));
            let voteChange = request.resource.data.upvotes - resource.data.upvotes;
            let isSingleInc = voteChange == 1 || voteChange == -1;

            let voteFirstTime = !exists(/databases/$(database)/documents/threads/$(threadID)/posts/$(postID)/votes/$(request.auth.uid))&& isSingleInc && voteDocAfter.data.change == voteChange;
            let voteDelete = voteDocAfter == null && isSingleInc && voteDoc.data.change != voteChange;
						let voteChangeOk = voteChange == 2 || voteChange == -2 && voteDocAfter.data.change == voteChange / 2 && voteDocAfter.data.change != voteDoc.data.change;
	
            return diffKeys().hasOnly(["upvotes"]) && (voteFirstTime || voteDelete || voteChangeOk);
        }
    }
}

